\documentclass[12pt,a4paper,titlepage]{article}
\usepackage{mathtools}
\usepackage{amssymb}
\usepackage{array}
\usepackage{subcaption}
\usepackage{setspace}
\newcommand{\ts}{\vdash}
\newcommand{\dts}{\vDash}
\newcommand{\tj}[3]{\mbox{(#1)$\dfrac{#2}{#3}$}\quad}

\title{Refinement Typed Lambda Calculus}
\author{Charlie Stanton}

\begin{document}
    \maketitle

    \section{Syntax}
    Figure \ref{fig:syntax} shows the grammar for the language syntax.
    There are 2 sorts, which are inherent types that new types can be constructed from: $nat$ and $bool$.
    Types can be constructed as sorts (which might be refined), the type of a function, a new type operator, or a type operator being applied.
    \begin{figure}
        \begin{minipage}[t]{0.5\textwidth}\vspace{0pt}%
            \begin{tabular}{>{$}l<{$}>{$}r<{$}>{$}l<{$}}
                \tau &\Coloneqq & x:\tau_1 \rightarrow \tau_2\\
                &| &x:nat\{\phi\}\\
                %&| &X\\
                %&| &\lambda X:Type . \tau\\
                %&| &\tau_1\ \tau_2\\
                \\
                \phi &\Coloneqq & e_1 < e_2\\
                &| &e_1 = e_2\\
                &| &\phi_1 \Rightarrow \phi_2\\
                &| &\phi_1 \land \phi2\\
                &| &\forall x:\tau.\phi\\
                &| &\bot\\
            \end{tabular}
        \end{minipage}%
        %
        \begin{minipage}[t]{0.5\textwidth}\vspace{0pt}%
            \begin{tabular}{>{$}l<{$}>{$}r<{$}>{$}l<{$}}
                e &\Coloneqq & x\\
                &| &0\\
                &| &S\ e\\
                &| &pred\ e\ e_0\ e_S\\
                &| &e_1\ e_2\\
                &| &\lambda x:\tau . e\\
                %&| &\lambda x:Type . e\\
            \end{tabular}
        \end{minipage}%
        \caption{Syntax of the language}
        \label{fig:syntax}
    \end{figure}

    \section{Typing Rules}
    Typing uses an environment, $\Gamma$, which contains variables and their types.

    $\Gamma$ has the form $x_0:\tau_1...$\\

    There are 6 mutually inductive typing judgements:
    \begin{itemize}
        \item $\Gamma \dts \phi$ Formula is valid in environment
        \item $\Gamma \ts e : t$ Expression has type in environment
        \item $\Gamma \ts \tau_1 <: \tau_2$ Subtype in environment
        %\item $\Gamma \ts w\!f$ Environment is well formed
        %\item $\Gamma \ts \phi\ w\!f$ Formula is well formed in environment
        %\item $\Gamma \ts \tau\ w\!f$ Type is well formed in environment
    \end{itemize}

    \begin{spacing}{2.5}
        \subsection{Typing}
        \begin{center}
            \tj{variable axiom}{
                x:\tau \in \Gamma
            }{
                \Gamma \ts x:\tau
            }
            \tj{zero axiom}{}{
                \Gamma \ts 0:\_:nat\{\bot \rightarrow \bot\}
            }
            \tj{successor}{
                \Gamma \ts e:\_:nat\{\bot \rightarrow \bot\}
            }{
                \Gamma \ts S\ e:\_:nat\{\bot \rightarrow \bot\}
            }
            \tj{predecessor}{
                \Gamma \ts e:nat \quad \Gamma \ts e_0:nat \quad \Gamma \ts e_S:nat \rightarrow nat
            }{
                \Gamma \ts pred\ e\ e_0\ e_S
            }
            \tj{abstraction}{
                \Gamma , x : \tau_1 \ts e:\tau_2
            }{
                \Gamma \ts (\lambda x:\tau_1 . e) : (\tau_1 \rightarrow \tau_2)
            }
            \tj{application}{
                \Gamma \ts e_1 : \sigma \rightarrow \tau \quad \Gamma \ts e_2 : \sigma
            }{
                \Gamma \ts e_1\ e_2 : \tau
            }
            \tj{substitute supertype}{
                \Gamma \ts e : \tau \quad \Gamma \ts \tau <: \tau'
            }{
                \Gamma \ts e : \tau'
            }
            \tj{refine}{
                \Gamma \ts e : \tau \quad \Gamma \dts \phi [ e / x ] \quad \tau \in B
            }{
                \Gamma \ts e : x : nat \{\phi\}
            }
        \end{center}
        \subsection{Validity}
        \begin{center}
            % TODO make the refinement types all be refinements of nat
            % TODO fix apostrophe
            % TODO make the <: look nicer
            \tj{refine'}{
                \Gamma \ts e : x : nat \{\phi\}
            }{
                \Gamma \dts \phi [ e / x ]
            }
            \tj{introduce and}{
                \Gamma \dts \phi_1 \quad \Gamma \dts \phi_2
            }{
                \Gamma \dts \phi_1 \land \phi_2
            }
            \tj{eliminate and}{
                \Gamma \dts \phi_1 \land \phi_2
            }{
                \Gamma \dts \phi_i
            }
            \tj{introduce imply}{
                \Gamma , _:nat\{\phi_1\} \dts \phi_2
            }{
                \Gamma \dts \phi_1 [ a / x ] \Rightarrow \phi_2
            }
            \tj{eliminate imply}{
                \Gamma \dts \phi_1 \Rightarrow \phi_2 \quad \Gamma \dts \phi_1
            }{
                \Gamma \dts \phi_2
            }
            \tj{introduce forall}{
                \Gamma , x : \tau \dts \phi
            }{
                \Gamma \dts \forall x:\tau . \phi
            }
            \tj{eliminate forall}{
                \Gamma \dts \forall x : \tau . \phi \quad \Gamma \ts e : \tau
            }{
                \Gamma \dts \phi [ e / x ]
            }
            \tj{lessthan transitive}{
                \Gamma \dts e_1 < e_2 \quad \Gamma \dts e_2 < e_3
            }{
                \Gamma \dts e_1 < e_3
            }
            \tj{lessthan successor}{
                \Gamma \dts e_1 < e_2
            }{
                \Gamma \dts S\ e_1 < S\ e_2
            }
            \tj{lessthan zero}{
                \Gamma \ts e : nat
            }{
                \Gamma \dts 0 < S\ e
            }
            \tj{equal reflexive}{
                \Gamma \ts e: \tau
            }{
                \Gamma \dts e = e
            }
            \tj{equal successor}{
                \Gamma \dts S\ e_1 = S\ e_2
            }{
                \Gamma \dts e_1 = e_2
            }
            \tj{equal substitution}{
                \Gamma \dts e = e' \quad \Gamma \ts e:\tau \quad \Gamma \ts e':\tau \quad \Gamma \dts \phi [e / x]
            }{
                \Gamma \dts \phi [e' / x]
            }
            \tj{equal reduction}{
                \Gamma \ts e : \tau \quad \Gamma \ts e' : \tau \quad \Gamma \ts e \rightsquigarrow e'
            }{
                \Gamma \dts e = e'
            }
            \tj{vacuous validity}{
                \Gamma \dts \bot \quad \Gamma \ts \phi wf
            }{
                \Gamma \dts \phi
            }
            \tj{introduce false}{
                \Gamma \dts e < 0
            }{
                \Gamma \dts \bot
            }
        \end{center}
        \subsection{Subtyping}
        \begin{center}
            \tj{subtype function}{
                \Gamma \ts \tau_3 <: \tau_1 \quad \Gamma \ts \tau_2 <: \tau_4
            }{
                \Gamma \ts \tau_1 \rightarrow \tau_2 <: \tau_3 \rightarrow \tau_4
            }
            \tj{refine subtype}{
                \Gamma \dts \phi_1 \Rightarrow \phi_2
            }{
                \Gamma \ts x:nat\{\phi_1\} <: x:nat\{\phi_2\}
            }
        \end{center}
        %\subsection{Type Reductions}
        %\begin{center}
        %    \tj{formula type reduction}{
        %        \Gamma \dts \phi [ (\lambda X : Type . \tau_1) \tau_2 / x ]
        %    }{
        %        \Gamma \dts \phi [ (\tau_1 [ \tau_2 / X ] ) / x ]
        %    }
        %    \tj{formula environment type reduction}{
        %        \Gamma , X : Type = \tau [ (\lambda Y : Type . \tau_1) \tau_2 / Z ] \dts \phi
        %    }{
        %        \Gamma , X : Type = \tau [ (\tau_1 [ \tau_2 / Y ]) / Z ] \dts \phi
        %    }
        %    \tj{expression type reduction}{
        %        \Gamma \ts e : \tau [ (\lambda X : Type . \tau_1) \tau_2 / x ]
        %    }{
        %        \Gamma \ts e : \tau [ (\tau_1 [ \tau_2 / X ] ) / x ]
        %    }
        %    \tj{expression environment type reduction}{
        %        \Gamma , X : Type = \tau [ (\lambda Y : Type . \tau_1) \tau_2 / Z ] \ts e
        %    }{
        %        \Gamma , X : Type = \tau [ (\tau_1 [ \tau_2 / Y ]) / Z ] \ts e
        %    }
        %\end{center}
        \subsection{Reduction Relation}
        The reduction relation is denoted by $\rightsquigarrow$ and its transitive and reflexive closure is
        denoted by $\rightsquigarrow^*$.

        $(\lambda x:\tau . e_1) e_2 \rightsquigarrow e_1 [ e_2 / x ]$

        $pred\ 0\ e_0\ e_S \rightsquigarrow e_0$

        $pred\ (S\ e)\ e_0\ e_S \rightsquigarrow e_S\ e$
    \end{spacing}
    %\section{Possibly a simpler syntax}
    %The syntax for the language could possibly be simplified by removing the 
    %\begin{figure}
    %    \begin{minipage}[t]{0.5\textwidth}\vspace{0pt}%
    %        \begin{tabular}{>{$}l<{$}>{$}r<{$}>{$}l<{$}}
    %            \tau &\Coloneqq & x:\tau'\{\phi\}\\
    %            \\
    %            \tau' &\Coloneqq & \tau'_1 \rightarrow \tau'_2\\
    %            &| &X\\
    %            &| &\lambda X:Type . \tau'\\
    %            &| &\tau'_1\ \tau'_2
    %            \\
    %            \phi &\Coloneqq & e_1 < e_2\\
    %            &| &e_1 = e_2\\
    %            &| &\phi_1 \Rightarrow \phi_2\\
    %            &| &\phi_1 \land \phi2\\
    %            &| &\forall x:\tau.\phi\\
    %            &| &\bot\\
    %        \end{tabular}
    %    \end{minipage}%
    %    \begin{minipage}[t]{0.5\textwidth}\vspace{0pt}%
    %        \begin{tabular}{>{$}l<{$}>{$}r<{$}>{$}l<{$}}
    %            e &\Coloneqq & x\\
    %            &| &0\\
    %            &| &S\ e\\
    %            &| &pred\ e\ e_0\ e_S\\
    %            &| &e_1\ e_2\\
    %            &| &\lambda x:\tau . e\\
    %            &| &\lambda x:Type . e\\
    %        \end{tabular}
    %    \end{minipage}%
    %    \caption{Possible simpler syntax}
    %    \label{fig:syntax}
    %\end{figure}
\end{document}
